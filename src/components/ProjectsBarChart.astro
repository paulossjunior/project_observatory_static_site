---
import { aggregateProjectsByYear, getProjectsChartData, getProjectsSummary, type ProjectCount } from '../utils/projectsData';

interface Props {
  title?: string;
  height?: number;
  showLegend?: boolean;
  aggregatedData?: ProjectCount[]; // Optional pre-aggregated data
}

const { 
  title = 'Projects by Year', 
  height = 400, 
  showLegend = true,
  aggregatedData: providedData
} = Astro.props;

// Use provided data if available, otherwise fetch all data
const aggregatedData = providedData ? providedData : await aggregateProjectsByYear();
const chartData = getProjectsChartData(aggregatedData);
const summary = getProjectsSummary(aggregatedData);

const hasData = aggregatedData.length > 0;
---

<div class="chart-container">
  {title && <h2 class="chart-title">{title}</h2>}
  
  {hasData ? (
    <>
      <div class="chart-wrapper">
        <canvas 
          id="projects-chart" 
          role="img"
          aria-label={`Bar chart showing ${summary.totalProjects} projects across ${summary.yearRange}. Research: ${summary.totalResearch}, Extension: ${summary.totalExtension}, Development: ${summary.totalDevelopment}`}
        ></canvas>
      </div>
      
      <div class="chart-summary" aria-live="polite">
        <p>
          Total Projects: <strong>{summary.totalProjects}</strong> 
          ({summary.totalResearch} Research, {summary.totalExtension} Extension, {summary.totalDevelopment} Development)
          <br />
          Year Range: <strong>{summary.yearRange}</strong>
        </p>
      </div>
    </>
  ) : (
    <div class="no-data-message">
      <p>No project data available to display.</p>
    </div>
  )}
</div>

<style>
  .chart-container {
    width: 100%;
    max-width: 1200px;
    margin: 2rem auto;
    padding: 1.5rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .chart-title {
    margin: 0 0 1.5rem 0;
    font-size: 1.5rem;
    font-weight: 600;
    color: #1f2937;
    text-align: center;
  }
  
  .chart-wrapper {
    position: relative;
    width: 100%;
    margin-bottom: 1rem;
  }
  
  canvas {
    max-width: 100%;
    height: auto !important;
  }
  
  .chart-summary {
    text-align: center;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 6px;
    margin-top: 1rem;
  }
  
  .chart-summary p {
    margin: 0;
    color: #4b5563;
    font-size: 0.95rem;
    line-height: 1.6;
  }
  
  .chart-summary strong {
    color: #1f2937;
    font-weight: 600;
  }
  
  .no-data-message {
    text-align: center;
    padding: 3rem 1rem;
    color: #6b7280;
  }
  
  .no-data-message p {
    margin: 0;
    font-size: 1.1rem;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .chart-container {
      padding: 1rem;
      margin: 1rem;
    }
    
    .chart-title {
      font-size: 1.25rem;
    }
    
    .chart-summary p {
      font-size: 0.875rem;
    }
  }
  
  /* Focus styles for accessibility */
  canvas:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }
</style>

{hasData && (
  <script define:vars={{ chartData, showLegend, height }}>
    // Load Chart.js from CDN
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js';
    script.onload = function() {
      initChart();
    };
    script.onerror = function() {
      console.error('Failed to load Chart.js');
      const canvas = document.getElementById('projects-chart');
      if (canvas && canvas.parentElement) {
        canvas.parentElement.innerHTML = '<p style="text-align: center; color: #ef4444;">Unable to load chart visualization. Please refresh the page.</p>';
      }
    };
    document.head.appendChild(script);
    
    function initChart() {
      const ctx = document.getElementById('projects-chart');
      
      if (!ctx) {
        console.error('Canvas element not found');
        return;
      }
      
      // Check if Chart is available
      if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded');
        return;
      }
      
      try {
        new Chart(ctx, {
          type: 'bar',
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
              legend: {
                display: showLegend,
                position: 'top',
                labels: {
                  padding: 15,
                  font: {
                    size: 12,
                    family: "'Inter', 'system-ui', sans-serif"
                  },
                  usePointStyle: true,
                  pointStyle: 'rect'
                }
              },
              tooltip: {
                mode: 'index',
                intersect: false,
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: {
                  size: 14,
                  weight: 'bold'
                },
                bodyFont: {
                  size: 13
                },
                callbacks: {
                  title: function(context) {
                    return 'Year: ' + context[0].label;
                  },
                  label: function(context) {
                    const label = context.dataset.label || '';
                    const value = context.parsed.y;
                    return label + ': ' + value + (value === 1 ? ' project' : ' projects');
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  precision: 0,
                  font: {
                    size: 11
                  }
                },
                title: {
                  display: true,
                  text: 'Number of Projects',
                  font: {
                    size: 12,
                    weight: 'bold'
                  }
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                }
              },
              x: {
                ticks: {
                  font: {
                    size: 11
                  }
                },
                title: {
                  display: true,
                  text: 'Year',
                  font: {
                    size: 12,
                    weight: 'bold'
                  }
                },
                grid: {
                  display: false
                }
              }
            },
            interaction: {
              mode: 'index',
              intersect: false
            }
          }
        });
      } catch (error) {
        console.error('Error initializing chart:', error);
        const canvas = document.getElementById('projects-chart');
        if (canvas && canvas.parentElement) {
          canvas.parentElement.innerHTML = '<p style="text-align: center; color: #ef4444;">Error rendering chart. Please try refreshing the page.</p>';
        }
      }
    }
  </script>
)}
