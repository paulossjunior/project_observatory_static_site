<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search Functionality Tests</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    
    .test-section {
      background: white;
      padding: 2rem;
      margin-bottom: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #1a1a1a;
      margin-bottom: 0.5rem;
    }
    
    h2 {
      color: #333;
      margin-top: 0;
      border-bottom: 2px solid #0066cc;
      padding-bottom: 0.5rem;
    }
    
    .test-item {
      padding: 1rem;
      margin: 1rem 0;
      background: #f9fafb;
      border-left: 4px solid #e5e7eb;
      border-radius: 4px;
    }
    
    .test-item.pass {
      border-left-color: #10b981;
      background: #f0fdf4;
    }
    
    .test-item.fail {
      border-left-color: #ef4444;
      background: #fef2f2;
    }
    
    .test-status {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .test-status.pass { color: #10b981; }
    .test-status.fail { color: #ef4444; }
    
    button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin: 0.5rem 0.5rem 0.5rem 0;
    }
    
    button:hover {
      background: #0052a3;
    }
    
    .test-results {
      margin-top: 1rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.875rem;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .result-preview {
      background: #1a1a1a;
      color: #10b981;
      padding: 1rem;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.875rem;
      margin: 0.5rem 0;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .result-item {
      padding: 0.5rem;
      margin: 0.25rem 0;
      border-bottom: 1px solid #333;
    }
    
    .result-item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <h1>üîç Search Functionality Tests</h1>
  <p>Functional testing for Requirements 1.2, 1.3, 1.4, 4.1</p>

  <!-- Test 1: Exact Match Searches -->
  <div class="test-section">
    <h2>Test 1: Exact Match Searches (Req 1.3)</h2>
    <p>Verify that exact match searches return correct results</p>
    
    <div id="exact-match-results"></div>
    <button onclick="runExactMatchTests()">Run Exact Match Tests</button>
  </div>

  <!-- Test 2: Fuzzy Matching -->
  <div class="test-section">
    <h2>Test 2: Fuzzy Matching with Typos (Req 4.1)</h2>
    <p>Test fuzzy matching with up to 2 character errors</p>
    
    <div id="fuzzy-match-results"></div>
    <button onclick="runFuzzyMatchTests()">Run Fuzzy Match Tests</button>
  </div>

  <!-- Test 3: Filter Functionality -->
  <div class="test-section">
    <h2>Test 3: Filter Functionality (Req 3.1-3.3)</h2>
    <p>Validate that filters work correctly</p>
    
    <div id="filter-results"></div>
    <button onclick="runFilterTests()">Run Filter Tests</button>
  </div>

  <!-- Test 4: Query Length and Special Characters -->
  <div class="test-section">
    <h2>Test 4: Query Length & Special Characters (Req 1.2)</h2>
    <p>Test with various query lengths and special characters</p>
    
    <div id="query-validation-results"></div>
    <button onclick="runQueryValidationTests()">Run Query Validation Tests</button>
  </div>

  <!-- Run All Tests -->
  <div class="test-section">
    <h2>Run All Functionality Tests</h2>
    <button onclick="runAllFunctionalityTests()" style="background: #10b981; font-size: 1.1rem; padding: 1rem 2rem;">
      ‚ñ∂ Run Complete Functionality Suite
    </button>
    <div id="all-tests-summary" style="margin-top: 1rem;"></div>
  </div>

  <script type="module">
    import { SearchEngine } from '/src/scripts/search-engine.js';

    window.SearchEngine = SearchEngine;
    window.testResults = {
      passed: 0,
      failed: 0,
      total: 0
    };
  </script>

  <script>
    function logTest(name, passed, message, details = '') {
      window.testResults.total++;
      if (passed) {
        window.testResults.passed++;
      } else {
        window.testResults.failed++;
      }
      return `<div class="test-item ${passed ? 'pass' : 'fail'}">
        <div class="test-status ${passed ? 'pass' : 'fail'}">${passed ? '‚úì PASS' : '‚úó FAIL'}: ${name}</div>
        <div>${message}</div>
        ${details ? `<div class="result-preview">${details}</div>` : ''}
      </div>`;
    }

    // Test 1: Exact Match Searches
    async function runExactMatchTests() {
      const container = document.getElementById('exact-match-results');
      container.innerHTML = '<p>Running exact match tests...</p>';
      
      const searchEngine = new window.SearchEngine();
      await searchEngine.loadIndex();
      
      let html = '';
      
      // Test 1.1: Search for "projeto"
      const results1 = await searchEngine.search('projeto');
      const hasResults1 = results1.length > 0;
      const hasProjectType = results1.some(r => r.item.type.includes('projeto'));
      
      html += logTest(
        'Search for "projeto"',
        hasResults1 && hasProjectType,
        `Found ${results1.length} results, includes project types: ${hasProjectType}`,
        hasResults1 ? `Sample: ${results1[0].item.title.substring(0, 100)}...` : ''
      );
      
      // Test 1.2: Search for "publica√ß√£o"
      const results2 = await searchEngine.search('publica√ß√£o');
      const hasResults2 = results2.length > 0;
      const hasPublicationType = results2.some(r => r.item.type === 'publicacao');
      
      html += logTest(
        'Search for "publica√ß√£o"',
        hasResults2 && hasPublicationType,
        `Found ${results2.length} results, includes publication types: ${hasPublicationType}`,
        hasResults2 ? `Sample: ${results2[0].item.title.substring(0, 100)}...` : ''
      );
      
      // Test 1.3: Search for specific person name
      const results3 = await searchEngine.search('Paulo');
      const hasResults3 = results3.length > 0;
      const hasPauloInResults = results3.some(r => 
        r.item.personName.toLowerCase().includes('paulo')
      );
      
      html += logTest(
        'Search for person name "Paulo"',
        hasResults3 && hasPauloInResults,
        `Found ${results3.length} results, includes Paulo in person name: ${hasPauloInResults}`,
        hasResults3 ? `Sample: ${results3[0].item.personName}` : ''
      );
      
      // Test 1.4: Search returns results in order
      const results4 = await searchEngine.search('software');
      const isOrdered = results4.length > 1 ? 
        results4[0].score <= results4[1].score : true;
      
      html += logTest(
        'Results ordered by relevance',
        isOrdered,
        `Results are properly ordered by score (lower is better in Fuse.js)`,
        results4.length > 0 ? `First result score: ${results4[0].score.toFixed(4)}` : ''
      );
      
      container.innerHTML = html;
    }

    // Test 2: Fuzzy Matching
    async function runFuzzyMatchTests() {
      const container = document.getElementById('fuzzy-match-results');
      container.innerHTML = '<p>Running fuzzy match tests...</p>';
      
      const searchEngine = new window.SearchEngine();
      await searchEngine.loadIndex();
      
      let html = '';
      
      // Test 2.1: 1 character typo
      const results1 = await searchEngine.search('projecto'); // should match "projeto"
      const hasResults1 = results1.length > 0;
      
      html += logTest(
        'Fuzzy match with 1 character error',
        hasResults1,
        `"projecto" (typo) found ${results1.length} results`,
        hasResults1 ? `Matched: ${results1[0].item.title.substring(0, 100)}...` : ''
      );
      
      // Test 2.2: 2 character typo
      const results2 = await searchEngine.search('pesquiza'); // should match "pesquisa"
      const hasResults2 = results2.length > 0;
      
      html += logTest(
        'Fuzzy match with 2 character errors',
        hasResults2,
        `"pesquiza" (typo) found ${results2.length} results`,
        hasResults2 ? `Matched: ${results2[0].item.title.substring(0, 100)}...` : ''
      );
      
      // Test 2.3: Case insensitive
      const results3a = await searchEngine.search('PROJETO');
      const results3b = await searchEngine.search('projeto');
      const caseInsensitive = results3a.length === results3b.length;
      
      html += logTest(
        'Case insensitive search',
        caseInsensitive,
        `"PROJETO" and "projeto" return same number of results: ${results3a.length}`,
        ''
      );
      
      // Test 2.4: Fuzzy indicator
      const results4 = await searchEngine.search('publicac√£o'); // typo
      const hasFuzzyIndicator = results4.length > 0 && 
        results4.some(r => r.isFuzzy !== undefined);
      
      html += logTest(
        'Fuzzy match indicator',
        hasFuzzyIndicator,
        `Fuzzy matches are marked with isFuzzy flag`,
        results4.length > 0 ? `First result isFuzzy: ${results4[0].isFuzzy}` : ''
      );
      
      container.innerHTML = html;
    }

    // Test 3: Filter Functionality
    async function runFilterTests() {
      const container = document.getElementById('filter-results');
      container.innerHTML = '<p>Running filter tests...</p>';
      
      const searchEngine = new window.SearchEngine();
      await searchEngine.loadIndex();
      
      let html = '';
      
      // Test 3.1: Filter by type
      const results1 = await searchEngine.search('projeto');
      const filtered1 = searchEngine.applyFilters(results1, {
        types: ['projeto-pesquisa']
      });
      const allCorrectType = filtered1.every(r => r.item.type === 'projeto-pesquisa');
      
      html += logTest(
        'Filter by content type',
        allCorrectType && filtered1.length > 0,
        `Filtered to "projeto-pesquisa": ${filtered1.length} results, all correct type: ${allCorrectType}`,
        filtered1.length > 0 ? `Sample: ${filtered1[0].item.type}` : ''
      );
      
      // Test 3.2: Multiple filters (AND logic)
      const results2 = await searchEngine.search('projeto');
      const filtered2 = searchEngine.applyFilters(results2, {
        types: ['projeto-pesquisa'],
        yearRange: { start: 2020, end: 2023 }
      });
      const allInRange = filtered2.every(r => {
        const year = parseInt(r.item.metadata.year);
        return year >= 2020 && year <= 2023;
      });
      
      html += logTest(
        'Multiple filters with AND logic',
        allInRange || filtered2.length === 0,
        `Filtered by type AND year range: ${filtered2.length} results`,
        filtered2.length > 0 ? `Sample year: ${filtered2[0].item.metadata.year}` : 'No results in range'
      );
      
      // Test 3.3: Count by type
      const results3 = await searchEngine.search('projeto');
      const counts = searchEngine.countByType(results3);
      const hasMultipleTypes = Object.keys(counts).length > 1;
      
      html += logTest(
        'Count results by type',
        hasMultipleTypes,
        `Found ${Object.keys(counts).length} different types`,
        `Types: ${JSON.stringify(counts, null, 2)}`
      );
      
      // Test 3.4: Get content types
      const types = searchEngine.getContentTypes();
      const hasTypes = types.length > 0;
      
      html += logTest(
        'Get available content types',
        hasTypes,
        `Found ${types.length} content types in index`,
        `Types: ${types.join(', ')}`
      );
      
      container.innerHTML = html;
    }

    // Test 4: Query Validation
    async function runQueryValidationTests() {
      const container = document.getElementById('query-validation-results');
      container.innerHTML = '<p>Running query validation tests...</p>';
      
      const searchEngine = new window.SearchEngine();
      await searchEngine.loadIndex();
      
      let html = '';
      
      // Test 4.1: Minimum 2 characters
      const results1 = await searchEngine.search('a');
      const rejectsShort = results1.length === 0;
      
      html += logTest(
        'Reject queries < 2 characters',
        rejectsShort,
        `Single character "a" returns ${results1.length} results (should be 0)`,
        ''
      );
      
      // Test 4.2: Accept 2 characters
      const results2 = await searchEngine.search('de');
      const acceptsMinimum = results2.length >= 0; // Should process, may or may not have results
      
      html += logTest(
        'Accept queries with 2 characters',
        acceptsMinimum,
        `Two characters "de" processed successfully, found ${results2.length} results`,
        ''
      );
      
      // Test 4.3: Special characters
      const results3 = await searchEngine.search('C++');
      const handlesSpecialChars = results3.length >= 0;
      
      html += logTest(
        'Handle special characters',
        handlesSpecialChars,
        `Query "C++" processed without errors, found ${results3.length} results`,
        ''
      );
      
      // Test 4.4: Accented characters
      const results4 = await searchEngine.search('publica√ß√£o');
      const handlesAccents = results4.length > 0;
      
      html += logTest(
        'Handle accented characters',
        handlesAccents,
        `Query "publica√ß√£o" with accents found ${results4.length} results`,
        results4.length > 0 ? `Sample: ${results4[0].item.title.substring(0, 100)}...` : ''
      );
      
      // Test 4.5: Long queries
      const results5 = await searchEngine.search('desenvolvimento de software com metodologias √°geis');
      const handlesLongQueries = results5.length >= 0;
      
      html += logTest(
        'Handle long queries',
        handlesLongQueries,
        `Long query processed successfully, found ${results5.length} results`,
        ''
      );
      
      // Test 4.6: Empty/whitespace queries
      const results6 = await searchEngine.search('   ');
      const rejectsEmpty = results6.length === 0;
      
      html += logTest(
        'Reject empty/whitespace queries',
        rejectsEmpty,
        `Whitespace-only query returns ${results6.length} results (should be 0)`,
        ''
      );
      
      container.innerHTML = html;
    }

    // Run all tests
    async function runAllFunctionalityTests() {
      window.testResults.passed = 0;
      window.testResults.failed = 0;
      window.testResults.total = 0;
      
      const summary = document.getElementById('all-tests-summary');
      summary.innerHTML = '<p><strong>Running all functionality tests...</strong></p>';
      
      await runExactMatchTests();
      await runFuzzyMatchTests();
      await runFilterTests();
      await runQueryValidationTests();
      
      const passRate = ((window.testResults.passed / window.testResults.total) * 100).toFixed(1);
      const summaryClass = passRate >= 80 ? 'pass' : passRate >= 60 ? 'pending' : 'fail';
      
      summary.innerHTML = `
        <div class="test-item ${summaryClass}">
          <h3>Functionality Test Summary</h3>
          <p><strong>Total Tests:</strong> ${window.testResults.total}</p>
          <p><strong>Passed:</strong> ${window.testResults.passed}</p>
          <p><strong>Failed:</strong> ${window.testResults.failed}</p>
          <p><strong>Pass Rate:</strong> ${passRate}%</p>
        </div>
      `;
    }

    // Make functions globally available
    window.runExactMatchTests = runExactMatchTests;
    window.runFuzzyMatchTests = runFuzzyMatchTests;
    window.runFilterTests = runFilterTests;
    window.runQueryValidationTests = runQueryValidationTests;
    window.runAllFunctionalityTests = runAllFunctionalityTests;
  </script>
</body>
</html>
